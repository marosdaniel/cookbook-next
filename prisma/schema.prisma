// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "mongodb"
  url      = env("MONGODB_URI")
}

enum UserRole {
  ADMIN
  USER
  BLOGGER
}

// User model
model User {
  id                    String    @id @default(auto()) @map("_id") @db.ObjectId
  firstName             String
  lastName              String
  userName              String    @unique
  email                 String    @unique
  password              String
  locale                String    @default("en")
  role                  UserRole  @default(USER)
  resetPasswordToken    String?
  resetPasswordExpires  DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Relations
  recipes               Recipe[]  @relation("UserRecipes")
  favoriteRecipeIds     String[]  @db.ObjectId
  favoriteRecipes       Recipe[]  @relation("FavoriteRecipes", fields: [favoriteRecipeIds], references: [id])
  ratings               Rating[]

  @@map("users")
}

// Recipe model
model Recipe {
  id                String              @id @default(auto()) @map("_id") @db.ObjectId
  title             String
  description       String?
  ingredients       Ingredient[]
  preparationSteps  PreparationStep[]
  category          Category
  labels            Label[]
  imgSrc            String?
  cookingTime       Int
  difficultyLevel   DifficultyLevel
  servings          Int
  youtubeLink       String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  // Author relation
  createdBy         String              @db.ObjectId
  author            User                @relation("UserRecipes", fields: [createdBy], references: [id])
  
  // Favorite relation
  favoritedByIds    String[]            @db.ObjectId
  favoritedBy       User[]              @relation("FavoriteRecipes", fields: [favoritedByIds], references: [id])
  
  // Ratings
  ratings           Rating[]

  @@map("recipes")
}

// Rating model
model Rating {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  ratingValue  Float
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relations
  recipeId     String   @db.ObjectId
  recipe       Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  
  userId       String   @db.ObjectId
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([recipeId, userId])
  @@map("ratings")
}

// Metadata model
model Metadata {
  id    String @id @default(auto()) @map("_id") @db.ObjectId
  name  String
  key   String @unique
  label String
  type  String // "CATEGORY" | "LABEL" | "DIFFICULTY_LEVEL"
  
  @@map("metadata")
}

// Embedded types (not collections, embedded in Recipe)

type Ingredient {
  id       String? @map("_id") @db.ObjectId
  localId  String
  name     String
  quantity Float
  unit     String
}

type PreparationStep {
  id          String? @map("_id") @db.ObjectId
  description String
  order       Int
}

type Category {
  id    String? @map("_id") @db.ObjectId
  name  String
  key   String
  label String
  type  String
}

type Label {
  id    String? @map("_id") @db.ObjectId
  name  String
  key   String
  label String
  type  String
}

type DifficultyLevel {
  id    String? @map("_id") @db.ObjectId
  name  String
  key   String
  label String
  type  String
}
